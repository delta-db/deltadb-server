#!/usr/bin/env node

'use strict';

var program = require('commander'),
  fs = require('fs'),
  config = require('../config'),
  clientConfig = require('../scripts/client/config');

// Options
program
  .version(JSON.parse(fs.readFileSync(__dirname + '/../package.json', 'utf8')).version)
  .usage('[options]')
  .option('-p, --port <port>', 'Port. Defaulted to 8080')
  .option('-P, --prefix <prefix>', 'DB name prefix useful for keeping test DB namespaces separate. Defaulted to delta_')
  .parse(process.argv);

// Map options to configurations
var configOpts = {
  port: 'PORT',
  prefix: 'DB_NAME_PREFIX'
};

// Set configurations
for (var opt in configOpts) {
  if (program[opt]) { // opt val specified?
    var configName = configOpts[opt];
    config[configName] = program[opt];
    clientConfig[configName] = program[opt];
  }
}

if (program.port) {
  // Use port to construct URL for client used internally by server
  // TODO: probably need to separate out host and other parts of URL in config
  clientConfig.URL = 'http://localhost:' + program.port;
}

// Start server
var Server = require('../scripts/server');
var server = new Server();
server.start();
